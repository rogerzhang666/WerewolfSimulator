# 狼人杀模拟器 - 技术架构图

## 整体架构概览

```mermaid
graph TB
    subgraph "前端层 Frontend Layer"
        UI[游戏界面]
        MEM[记忆调试器]
        CTRL[控制面板]
    end
    
    subgraph "通信层 Communication Layer"
        WS[WebSocket]
        HTTP[HTTP API]
    end
    
    subgraph "应用层 Application Layer"
        ENGINE[游戏引擎]
        ROUTER[API路由]
        SOCKET[Socket处理器]
    end
    
    subgraph "业务层 Business Layer"
        GAME[游戏逻辑]
        CHARACTER[角色管理]
        MEMORY[记忆管理]
    end
    
    subgraph "AI层 AI Layer"
        AI_CLIENT[AI客户端]
        PROMPT[提示词模板]
        QWEN[通义千问API]
    end
    
    subgraph "数据层 Data Layer"
        CONFIG[配置文件]
        LOG[日志系统]
        STATE[游戏状态]
    end
    
    UI --> WS
    MEM --> HTTP
    CTRL --> WS
    
    WS --> ENGINE
    HTTP --> ROUTER
    WS --> SOCKET
    
    ENGINE --> GAME
    ENGINE --> CHARACTER
    ENGINE --> MEMORY
    
    CHARACTER --> AI_CLIENT
    AI_CLIENT --> PROMPT
    AI_CLIENT --> QWEN
    
    GAME --> CONFIG
    ENGINE --> LOG
    CHARACTER --> STATE
```

## 模块依赖关系

```mermaid
graph LR
    subgraph "Core Modules"
        A[Game Engine] --> B[Character Manager]
        A --> C[Memory Manager] 
        B --> D[AI Client]
        C --> D
    end
    
    subgraph "AI Services"
        D --> E[Qwen Client]
        D --> F[Prompt Templates]
        E --> G[DashScope API]
    end
    
    subgraph "Frontend"
        H[Game UI] --> I[WebSocket Client]
        J[Memory Debugger] --> I
        K[Control Panel] --> I
    end
    
    subgraph "Backend Services"
        L[Flask App] --> M[Socket.IO Server]
        L --> N[API Routes]
        M --> A
        N --> A
    end
```

## 数据流图

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant GameEngine
    participant Character
    participant AIClient
    participant QwenAPI
    
    User->>Frontend: 点击开始游戏
    Frontend->>GameEngine: 发送开始指令
    GameEngine->>Character: 初始化角色
    Character->>AIClient: 请求AI决策
    AIClient->>QwenAPI: 调用API
    QwenAPI-->>AIClient: 返回AI响应
    AIClient-->>Character: 处理后的决策
    Character-->>GameEngine: 角色行动
    GameEngine-->>Frontend: 广播游戏更新
    Frontend-->>User: 显示游戏进展
```

## 核心类关系图

```mermaid
classDiagram
    class GameEngine {
        -game: Game
        -socketio: SocketIO
        -ai_clients: dict
        +start_game()
        +game_loop()
        +handle_phase()
    }
    
    class Game {
        -characters: list
        -current_day: int
        -phase: GamePhase
        -status: GameStatus
        +add_character()
        +get_alive_characters()
        +next_phase()
    }
    
    class Character {
        -name: str
        -role: str
        -memory: dict
        -alive: bool
        +add_memory()
        +get_context()
        +add_inner_thought()
    }
    
    class MemoryManager {
        +update_memory()
        +build_context()
        +filter_memories()
    }
    
    class QwenClient {
        -api_key: str
        -api_url: str
        +generate_response()
    }
    
    GameEngine --> Game
    GameEngine --> Character
    GameEngine --> QwenClient
    Character --> MemoryManager
    Character --> QwenClient
```

## 技术栈详情

### 后端技术栈
- **Python 3.9+**: 主要开发语言
- **Flask**: Web框架
- **Socket.IO**: 实时通信
- **Requests**: HTTP客户端
- **Threading**: 多线程处理
- **JSON**: 数据格式
- **Datetime**: 时间处理

### 前端技术栈
- **HTML5**: 页面结构
- **CSS3**: 样式设计
- **JavaScript (ES6+)**: 交互逻辑
- **Socket.IO Client**: 实时通信
- **Fetch API**: HTTP请求

### AI服务
- **阿里百联 DashScope**: AI服务平台
- **通义千问-Turbo-Latest**: 语言模型
- **自定义提示词工程**: 角色扮演优化

### 开发工具
- **Git**: 版本控制
- **Python venv**: 虚拟环境
- **dotenv**: 环境变量管理
- **Markdown**: 文档编写

## 部署架构

```mermaid
graph TB
    subgraph "部署环境"
        subgraph "本地开发"
            DEV[开发服务器]
            VENV[Python虚拟环境]
            LOCAL_AI[本地AI调试]
        end
        
        subgraph "生产环境"
            PROD[生产服务器]
            NGINX[Nginx反向代理]
            SSL[SSL证书]
        end
        
        subgraph "外部服务"
            DASHSCOPE[阿里百联API]
            CDN[静态资源CDN]
        end
    end
    
    DEV --> VENV
    DEV --> LOCAL_AI
    PROD --> NGINX
    NGINX --> SSL
    PROD --> DASHSCOPE
    NGINX --> CDN
```

## 性能指标

### 系统性能要求
- **响应时间**: API调用 < 3秒
- **并发支持**: 单实例支持10个并发游戏
- **内存使用**: < 512MB
- **CPU使用**: < 50%

### AI服务性能
- **AI响应时间**: < 5秒
- **API成功率**: > 95%
- **降级响应时间**: < 100ms
- **内容质量**: 角色一致性 > 90%

## 安全考虑

### API安全
- API密钥环境变量存储
- 请求频率限制
- 错误信息脱敏
- 日志敏感信息过滤

### 数据安全
- 内存数据定期清理
- 用户输入验证
- XSS防护
- CSRF保护

---

*本文档随项目开发持续更新*
